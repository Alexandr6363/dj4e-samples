{% extends 'base_bootstrap.html' %}
{% block content %}
<p>Lets get some JSON using async / await.  Turn on your developer console and press the buttons below:</p>
<p>
<button onclick="loadUrl('hddp://x/broken', 'urlfail');return false;">URL Fail</button>
</p>
<p id="urlfail">New text will not go here</span></p>
<p>
<button onclick="loadUrl('/broken', 'response');return false;">Response Fail</button>
</p>
<p id="response">New text will not go here</span></p>
<p>
<button onclick="loadUrl('{% url 'chat:jsonfun' %}', 'working');return false;">Retrieve Data</button> 
</p>
<p id="working">New text will go here!!!! <span style="color:green;">(be patient)</span></p>
<script type="text/javascript">

async function loadUrl(url, id) {
    console.log("Loading", url);
    document.getElementById(id).style.color = 'orange';
    document.getElementById(id).innerHTML = 'Loading...';

    const request = fetch(url).catch((error) => {
        const txt = 'Request Failed\nURL:'+url+'\nError:'+error;
        document.getElementById(id).innerHTML = txt;
        document.getElementById(id).style.color = 'red';
        console.log(txt);
        return false;
    });
    console.log('request', request);

    const response = await request;
    console.log('response', response);
    if ( response == false ) return;

    if ( ! response.ok ) {
        const txt = 'Fetch Failed\nURL:'+url+'\nStatus:'+response.status+' '+response.statusText;
        console.log(txt);
        document.getElementById(id).innerHTML = txt;
        document.getElementById(id).style.color = 'red';
        return;
    }
    const data = await response.json();
    console.log('JSON data', data);
    document.getElementById(id).style.color = 'green';
    document.getElementById(id).innerHTML = 'Async: ' + data.first;
}

</script>
{% endblock %}
</body>
